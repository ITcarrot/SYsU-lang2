# 编译原理实验4
|姓名|罗以彬|学号|21307270|
|---|---|---|---|

## 实验要求
本次实验的实验内容是实现一个LLVM IR优化器，对中间代码生成的结果进行优化。实验的输入与输出均为LLVM IR，要求同学们在保证代码正确性的基础上面向给定测试样例进行代码优化。在LLVM中，中端优化函数以Pass的形式存在，其作用是对输入的LLVM IR进行分析与变换，并输出变换后的LLVM IR。每个优化由一个或多个Transform Pass实现，不同优化的pass之间相互独立。在本次实验没有标准答案，同学们可以自由发挥，借助任何可能的优化方法提升程序的运行效率，并通过测评系统测评。

### 评分标准
实验的评分主要分为两个部分：正确性与程序运行性能。对于一个编译器而言，保证正确性是必然要求。中间代码优化实验的比较对象为`clang O2`，对于每个实验测例，我们将比较优化后的程序运行的输出与返回值：若两者相同，则进入性能测试；若两者不相同，则实验得分为0。

通过正确性验证后，我们将`clang O2`优化后的程序运行时间与优化器优化后的程序运行时间求比值后开平方，再将性能测例中每个测例的分数取平均值，结果即为性能测例得分。若某测例在优化器优化后运行性能超过`clang O2`，则该测例记为满分。**实验四将综合考虑同学们实现的优化、测评系统中排行榜的排名以及性能测例得分进行赋分，性能测例分数并非实验四最终得分。**

本次实验不允许出现以下行为，若出现以下行为将视为作弊与抄袭：

* 面向测例编程，包括但不限于：通过识别文件名、输入、特定代码段等手段进行代码优化
* 直接调用LLVM内置的**Transform Pass**，或者直接复制LLVM提供的Transform Pass代码

我们允许以下行为：

* 在理解LLVM优化源代码的基础上将其简化移植
* 使用LLVM提供的**Analysis Pass**获取优化所需的信息（Transform Pass和Analysis Pass的区别是前者执行后会修改LLVM IR，而后者仅返回信息不改变IR）
* 鼓励同学们添加实验测例中未涉及到的优化并提供相应测例（可在实验报告中说明，我们将在分析优化效果与优化实现难度后酌情加分）

## 实验过程
### 全局常量检测
- 检测全局变量是否在初始化以外的地方被赋值，如果没有则将它作为常量替换
- **非正确优化**：在多文件编译中，全局变量可能会被其他文件修改，这个优化只有在单文件编译时是安全的
- 遍历所有全局变量，检查它的User里是否有load以外的指令，如果没有，则将load结果替换为常量

### 常量传播+常量折叠+算术常量+常量表达式合并
- 由于这四种优化方法都会产生新的常量，每一次优化可能带来更多的优化机会，因此在一个pass内完成
- 遍历所有二元运算指令：
  - 如果两个操作数是常量，则将其结果替换为常量
  - 如果一个操作数是常量，检查是否为算术恒等式
    - 若是则将其结果替换为常量或操作数
    - 否则遍历他的user，检查user是不是涉及常量的表达式，是则尝试合并常量

### 死代码消除
- 从后往前检查每条指令是否被使用过，没有则将其删除
- 由于llvm ir是SSA形式，因此这是可行的
